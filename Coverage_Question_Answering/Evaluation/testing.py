from deepeval import evaluate
from deepeval.metrics import ContextualRecallMetric
from deepeval.test_case import LLMTestCase

# Replace this with the actual output from your LLM application
actual_output = """ "Based on the policy documents, cryptojacking is not explicitly mentioned under the Service Fraud coverage. The Service Fraud endorsement specifically covers direct financial loss incurred as a result of being charged for the fraudulent use of business services resulting from a security failure.

Regarding the second part of your query, the policy documents do not explicitly state that the absence of Multi-Factor Authentication (MFA) will exclude coverage for Invoice Manipulation and Social Engineering. The provided context mentions that the largest applicable Retention amount will be reduced by 50% (subject to a maximum reduction of $10,000) if MFA was enabled and required at the time of a business email compromise incident. However, it does not specify that coverage for Invoice Manipulation and Social Engineering is contingent on the presence of MFA.

Therefore, cryptojacking is not covered under Service Fraud, and the absence of MFA does not explicitly exclude coverage for Invoice Manipulation and Social Engineering based on the provided policy documents."""

# Replace this with the expected output from your RAG generator
expected_output = """ "

Yes, cryptojacking is covered under Service Fraud on our policy. No MFA will mean we cannot offer invoice manipulation but social engineering will still have coverage under Funds Transfer Fraud.

"""

# Replace this with the actual retrieved context from your RAG pipeline
retrieval_context = ['FILINGPOLICYNO.: C-4MQ8-472146-CYBER-2024\nENDT.NO.: 06\nSERVICEFRAUDENDORSEMENT\nFormNumber SP161830518\nEffectiveDateofEndorsement June18,2024\nNamedInsured CritchfieldSpecialtyInfusionGroupLLC\nFilingPolicyNumber C-4MQ8-472146-CYBER-2024\nIssuedby\n(NameofInsuranceCompany)ArchSpecialtyInsuranceCompany,\nAllianzUnderwritersInsuranceCompany,\nAscotSpecialtyInsuranceCompany,\nFortegraSpecialtyInsuranceCompany\nTHISENDORSEMENTCHANGESTHEPOLICY.PLEASEREADITCAREFULLY.\nThisendorsementmodifiesinsuranceprovidedunderthefollowing:\nCOALITIONCYBERPOLICY\nInconsiderationofthepremiumchargedforthisPolicy,itisherebyunderstoodandagreedthat:\n1.Item5. FIRSTPARTYCOVERAGESoftheDeclarationsisamendedtoincludethefollowing:\nInsuringAgreement Limit/Sub-Limit Retention/Sub-Retention\nSF.SERVICEFRAUD $250,000 $5,000\n2.SectionII,FIRSTPARTYCOVERAGESisamendedbytheadditionofthefollowinginsuringagreement:\nSF.SERVICEFRAUD Wewe will reimburse youfor direct financial loss that youincur as the\nresult of youbeing charged for the fraudulent use of business services\nresultingfroma securityfailure , providedthatsuchdirectfinanciallossis\nfirstdiscoveredby youandincurredby youduringthe policyperiod .\n3.For purposes of the coverage provided under Insuring Agreement, SF. Service Fraud only, the following\ndefinitionunderSectionIX,DEFINITIONSisadded:\nSP161830518 1of2', 'In the event that damages, PCI fines and assessments , regulatory \npenalties, claim expenses, breach response costs , business \ninterruption loss, crisis management costs , cyber extortion \nexpenses, extra expenses, funds transfer loss , restoration costs, \nor other amounts arise out of a claim or incident that is the direct \nresult of a business email compromise , the largest applicable \nRetention amount will be reduced by 50% subject to a maximum \nreduction of $10,000, provided that multi-factor authentication  was \nenabled and required at the time of the applicable incident.\n2.Section IX, DEFINITIONS is amended by the addition of the following definitions:\nBusiness email \ncompromisemeans any access to or use of your email system in a manner that is \nnot authorized by you.\nMulti-factor \nauthenticationmeans, in addition to the use of a user ID and password to validate\naccess to your email system, the use of at least one of the following\nmethods of authentication:\na.a hardware or software token or access card; \nb.third party authentication applications providing time bound,\none-time codes, by a method other than text messaging; or\nc.text messaging authentication .\nText messaging \nauthenticationThe use or receipt of a unique one-time passcode received by text \nmessage to a pre-established mobile number linked to the email \naccount on your email system that is being accessed in order to \nvalidate access to your email system.\nAll other terms and conditions of this Policy remain unchanged.\nThis endorsement forms a part of the Policy to which attached, effective on the inception date of \nthe Policy unless otherwise stated herein.\n SP 17 814 0819 Page 2 of 2', 'SP 14 798 0419    Page 3 of 27 \nJ. FUNDS TRANSFER FRAUD \n We will pay on your behalf direct funds transfer loss  that you incur \nresulting from a funds transfer fraud  first discovered by you during the \npolicy period . \nSECTION III  \nEXCLUSIONS – WHAT IS NOT \nCOVERED  This policy does not apply to and we will not make any payment for any \nclaim expenses , damages , loss, regulatory penalties , PCI fines and \nassessments , or any other amounts  directly or indirectly arising out of, \nresulting from, based upon, or attributable to:  \nA. BODILY INJURY Any physical injury, sickness, disease, mental anguish, emotional distress, or \ndeath of any person, provided, however, that this exclusion will not apply to \nany claim for mental anguish or emotional distress under Section II.A , \nNETWORK AND INFORMATION SECURITY LIABILITY.  \nB. CONFISCATION Confiscation, nationalization, requisition, destruction of, or damage to any \nproperty, computer system , software, or electronic data by order of any \ngovernmental or public authority. \nC. CONTRACTUAL LIABILITY  Any contractual liability or obligation or any breach of contract or \nagreement either oral or written, provided, however, that this exclusion will \nnot apply: \n \n1. with respect to the coverage provided by Section II.A, NETWORK \nAND INFORMATION SECURITY LIABILITY, and Section II.E, BREACH \nRESPONSE, to your obligations to maintain the confidentiality or \nsecurity of personally identifiable information  or third party \ncorporate information ;  \n2. with respect to the coverage provided by Section II.C, MULTIMEDIA \nCONTENT LIABILITY, to misappropriation of ideas under implied \ncontract; \n3. with respect to the coverage provided by Section II.D, PCI FINES \nAND ASSESSMENTS; and \n4. to the extent you would have been liable in the absence of such \ncontract or agreement.', 'FILINGPOLICYNO.: C-4MQ8-472146-CYBER-2024\nENDT.NO.: 20\nINVOICEMANIPULATIONENDORSEMENT\nFormNumber SP178130819\nEffectiveDateofEndorsement June18,2024\nNamedInsured CritchfieldSpecialtyInfusionGroupLLC\nFilingPolicyNumber C-4MQ8-472146-CYBER-2024\nIssuedby\n(NameofInsuranceCompany)ArchSpecialtyInsuranceCompany,\nAllianzUnderwritersInsuranceCompany,\nAscotSpecialtyInsuranceCompany,\nFortegraSpecialtyInsuranceCompany\nTHISENDORSEMENTCHANGESTHEPOLICY.PLEASEREADITCAREFULLY.\nThisendorsementmodifiesinsuranceprovidedunderthefollowing:\nCOALITIONCYBERPOLICY\nInconsiderationofthepremiumchargedforthisPolicy,itisherebyunderstoodandagreedthat:\n1.Item5. oftheDeclarationsisamendedtoincludethefollowing:\nInsuringAgreement Limit/Sublimit Retention\nIM.INVOICEMANIPULATION $250,000 $5,000\n2.SectionII,FIRSTPARTYCOVERAGESisamendedbytheadditionofthefollowinginsuringagreement:\nIM.INVOICEMANIPULATION Wewill payyou invoice manipulation loss thatyouincur directly\nresultingfromany invoicemanipulation firstdiscoveredby youduring\nthepolicyperiod .\n3.SectionIX,DEFINITIONSisamendedbytheadditionofthefollowingdefinitions:\nInvoiceManipulation means the release or distribution of any fraudulent invoice or payment\ninstructiontoathirdpartyasadirectresultofa securityfailure .\nInvoiceManipulationLoss meansyourdirect net costs, excluding any profit, to provide goods,\nproducts,orservicestoathirdpartyforwhich youareunabletocollect\npayment after transfer of such goods, products, or services to a third\npartyasadirectresultofan invoicemanipulation .\n4.ForpurposesofthecoverageprovidedunderthisEndorsementonly,thefollowingdefinitionsunderSection\nIX,DEFINITIONSisdeletedandreplacedwiththefollowing:\nSP178130819 1of2', 'appealable adjudication in the underlying action establishes that a senior \nexecutive committed such dishonest, fraudulent, criminal, or malicious act or\nomission, at which time the named insured will reimburse us for all claim \nexpenses we incurred or paid in defending such claim.\nThis exclusion will not apply to any insured person who did not allegedly or \nactually participate in or otherwise be involved in the dishonest, fraudulent, \ncriminal, or malicious act or omission.\n7.SECTION  III,  EXCLUSIONS  –  WHAT  IS  NOT  COVERED,  Paragraph  W.  VIOLATIONS  OF\nACTS/LAWS is deleted and replaced with the following:\nW.VIOLATION OF \nACTS/LAWSAny violation of:\n1.the Employee Retirement Income Security Act of 1974 (ERISA);\n2.the Securities Act of 1933, the Securities Exchange Act of 1934, the \nInvestment Act of 1940, and any other federal or state securities laws;\n3.the Organized Crime Control Act of 1970 (RICO); \n4.the Controlling the Assault of Non-Solicited Pornography and \nMarketing Act of 2003 (CAN-SPAM);\n5.Telephone Consumer Protection Act (TCPA); \n6.the Sherman Anti-Trust Act, the Clayton Act, or any price fixing, \nrestraint of trade, or monopolization statute; or \n7.any similar local, state, federal, common, or foreign laws or legislation \nto the laws described in 1. through 6. above;\nhowever, this exclusion shall not apply to a claim against you alleging\na data breach or security failure in violation of regulation S-P (17 C.F.R. § \n248).', '6.SECTION III, EXCLUSIONS – WHAT IS NOT COVERED, Paragraph G. FRAUD BY A SENIOR\nEXECUTIVE is deleted and replaced with the following:\nG.FRAUD BY A SENIOR \nEXECUTIVEAny dishonest, fraudulent, criminal, or malicious act or omission of any senior \nexecutive. However, this exclusion does not apply to claim expenses \nincurred in defending any such claim until and unless a final and non-\nCYUSP-50EN-050001-1222-01 Page 2 of 11', 'SP 14 798 0419    Page 6 of 27 \nR. REPAIR \n \n \n \n \n \n Any repair, replacement, recreation, restoration, or maintenance of any \nproperty, tangible or intangible, including computer systems  and their \ncomponent parts, mobile devices, and mechanical equipment. This \nexclusion does not apply to damages  that you are legally obligated to pay \nresulting from a claim and that are otherwise covered under this Policy, or \nto coverage afforded under Sections II.H, BUSINESS INTERRUPTION AND \nEXTRA EXPENSES, and II.I, DIGITAL ASSET RESTORATION. \nS. RETROACTIVE DATE Any incident, act, error, or omission that took place prior to the \nretroactive date , or any related or continuing acts, errors, omissions, or \nincidents  where the first such act, error, omission, or incident first took \nplace prior to the retroactive date .  \nT. TANGIBLE PROPERTY Any injury or damage to, destruction, impairment, or loss of use of any \ntangible property, including any computer hardware rendered unusable by \na security failure . \nU. THIRD PARTY \nMECHANICAL FAILURE Electrical, mechanical failure, or interruption (including blackouts, \nbrownouts, power surge, or outage) or other utility failure, interruption, or \npower outage, of a third party, including telecommunications and other \ncommunications, internet service, website hosts, server services, satellite, \ncable, electricity, gas, water, or other utility or power service providers. \nHowever, this exclusion will not apply to business interruption loss  under \nSection II.H, BUSINESS INTERRUPTION AND EXTRA EXPENSES, where such \nloss arises directly from the service provider  directly experiencing their \nown security failure . \nV. UNFAIR TRADE PRACTICE Any false, unlawful, deceptive, or unfair trade practices; however, this \nexclusion does not apply to a claim under Section II.B, REGULATORY \nDEFENSE AND PENALTIES arising from a security failure  or data breach .', 'SP 14 798 0419    Page 5 of 27 \nL. MERCHANT LIABILITY Any charge back, interchange fee, discount fee, service related fee, rate, or \ncharge; or liability or fee incurred by you due to a merchant service \nprovider, payment processor, payment card company, or bank reversing or \nfreezing payment transactions, except that this exclusion will not apply to \ncoverage afforded under Section II.D, PCI FINES AND ASSESSMENTS.  \nM. NATURAL DISASTER Any physical event or natural disaster, including fire, flood, earthquake, \nvolcanic eruption, explosion, lightning, wind, hail, tidal wave, and landslide.  \nN. NUCLEAR Any exposure or threatened exposure to any radioactive matter or any form \nof radiation or contamination by radioactivity of any kind or from any \nsource. This exclusion applies regardless of whether any other causes, \nevents, materials, or products contributed concurrently or in any sequence \nto the claim or incident, or the liability or legal obligation alleged or \nexisting. \nO. POLLUTANTS  Any:  \n \n1.  discharge, dispersal, seepage, migration, release, or escape of \npollutants , or any threatened discharge, seepage, migration, \nrelease, or escape of pollutants ; or \n2.  request, demand, order, or statutory or regulatory requirement \nthat you or others detect, report, test for, monitor, clean up, \nremove, remediate, contain, treat, detoxify, or neutralize, or in any \nway respond to, or assess the effects of pollutants ; including any \nclaim, suit, notice, or proceeding by or on behalf of any \ngovernmental authority or quasi-governmental authority, a \npotentially responsible party or any other person or entity for any \namounts whatsoever because of detecting, reporting, testing for, \nmonitoring, cleaning up, removing, remediating, containing, \ntreating, detoxifying, or neutralizing, or in any way responding to, \nor assessing the effects of pollutants .', 'SP 14 798 0419    Page 4 of 27 \nG. FRAUD BY A SENIOR \nEXECUTIVE Any dishonest, fraudulent, criminal, or malicious act or omission of any \nsenior executive . However, this exclusion does not apply to claim \nexpenses  incurred in defending any such claim until and unless a final and \nnon-appealable adjudication establishes that a senior executive  \ncommitted such dishonest, fraudulent, criminal, or malicious act or \nomission, at which time the named insured  will reimburse us for all claim \nexpenses  we incurred or paid in defending such claim. \n \nThis exclusion will not apply to any insured person who did not allegedly or \nactually participate in or otherwise be involved in the dishonest, fraudulent, \ncriminal, or malicious act or omission.  \nH. GOVERNMENTAL ORDERS Any court order or demand requiring you to provide personally \nidentifiable information  to any domestic or foreign law enforcement, \nadministrative, regulatory, or judicial body or other governmental authority. \nI. ILLEGAL REMUNERATION  Any profit, remuneration , or advantage to which you are not legally entitled.  \nHowever, this exclusion does not apply to claim expenses  incurred in \ndefending any such claim until and unless a final and non-appealable \nadjudication establishes the gaining of any profit, remuneration, or \nadvantage to which you are not legally entitled, at which time the named \ninsured will reimburse us for all claim expenses  we incurred or paid in \ndefending such claim.  \nJ. INSURED VERSUS \nINSURED Any claim made by or on behalf of : \n \n1. an insured under this Policy; however, this exclusion will not apply \nto an otherwise covered claim made by an employee  arising from \na security failure  or data breach ; \n2. any business enterprise in which you have greater than a twenty \npercent (20%) ownership interest; or \n3. any parent company or other entity that owns more than twenty \npercent (20%) of an insured.', 'SP 14 798 0419    Page 2 of 27 \n  \nTHIRD PARTY LIABILITY COVERAGES \n \nA. NETWORK AND \nINFORMATION SECURITY \nLIABILITY We will pay on your behalf claim expenses  and damages  that you \nbecome legally obligated to pay resulting from a claim against you for a \nsecurity failure , data breach , or privacy liability . \nB. REGULATORY DEFENSE \nAND PENALTIES We will pay on your behalf claim expenses  and regulatory penalties  that \nyou become legally obligated to pay resulting from a claim against you in \nthe form of a regulatory proceeding  for a security failure  or data \nbreach. \nC. MULTIMEDIA CONTENT \nLIABILITY We will pay on your behalf claim expenses  and damages  that you \nbecome legally obligated to pay resulting from a claim against you for a \nmultimedia wrongful act . \nD. PCI FINES AND \nASSESSMENTS We will pay on your behalf PCI fines and assessments  that you become \nlegally obligated to pay resulting from a claim against you for a security \nfailure or data breach  compromising payment card data.  \n  \n \nFIRST PARTY COVERAGES \nE. BREACH RESPONSE We will pay on your behalf breach response costs  resulting from an actual \nor suspected security failure  or data breach  first discovered by you \nduring the  policy period .  \nF. CRISIS MANAGEMENT \nAND PUBLIC RELATIONS We will pay on your behalf crisis management costs  resulting from a \npublic relations event  first discovered by you during the  policy period . \nG. CYBER EXTORTION \n We will pay on your behalf cyber extortion expenses  resulting from \ncyber extortion  first discovered by you during the policy period . \nH. BUSINESS \nINTERRUPTION AND \nEXTRA EXPENSES  \n We will pay business interruption loss  and extra expenses  that you \nincur during the indemnity period  directly resulting from the partial or \ncomplete interruption of computer systems  for a period longer than the \nwaiting period  caused by a security failure  or systems failure  first \ndiscovered by  you during the  policy period .']
print(retrieval_context[0])
print("//////////////////////"*100)
print(retrieval_context[1])
print("//////////////////////"*100)

print(retrieval_context[2])

metric = ContextualRecallMetric(
    threshold=0.7,
    model="gpt-4o",
    include_reason=True
)
test_case = LLMTestCase(
    input="What if these shoes don't fit?",
    actual_output=actual_output,
    expected_output=expected_output,
    retrieval_context=retrieval_context
)

metric.measure(test_case)
print(metric.score)
print(metric.reason)

# or evaluate test cases in bulk
evaluate([test_case], [metric])